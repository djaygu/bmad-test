# Story 1.1: Initial System Configuration

## Status
Approved

## Story
**As a** quantitative researcher,  
**I want** to configure the SPX data pipeline through CLI commands,  
**so that** I can customize the system for my local environment and data requirements.

## Acceptance Criteria
1. I can set ThetaData base URL to match my ThetaTerminal configuration
2. I can configure processing start date for historical data backfill
3. I can specify output directories for parquet files and temporary processing files
4. I can validate my configuration before starting any processing
5. Configuration changes are persisted and survive system restarts
6. Invalid configuration values display helpful error messages with correction guidance

## Tasks / Subtasks

- [x] **Task 1: Configuration Schema Design** (AC: 1,2,3,4,6)
  - [x] Define TypeScript configuration schema types with validation rules
  - [x] Create default configuration values matching architecture specifications
  - [x] Implement Effect Schema validation for all configuration fields
  - [x] Add comprehensive validation error messages with remediation guidance

- [x] **Task 2: SQLite Configuration Storage** (AC: 4,5)
  - [x] Create configuration table schema in SQLite database
  - [x] Implement configuration CRUD operations using @effect/sql-sqlite
  - [x] Add configuration versioning and change tracking
  - [x] Handle database schema migrations for configuration changes

- [x] **Task 3: CLI Configuration Commands Implementation** (AC: 1,2,3,4,6)
  - [x] Implement `spx-data config set <key> <value>` command using @effect/cli
  - [x] Implement `spx-data config get [key]` command with optional key filtering
  - [x] Implement `spx-data config validate` command with comprehensive checks
  - [x] Implement `spx-data config reset` command with confirmation prompts

- [x] **Task 3a: Database Initialization System** (AC: 5)
  - [x] Implement safe database initialization with table existence verification
  - [x] Create `spx-data database status` command to show table status and row counts
  - [x] Create `spx-data database init` command with data preservation safeguards
  - [x] Create `spx-data database force-init` command with explicit confirmation requirements
  - [x] Add centralized table creation management for future extensibility

- [ ] **Task 4: Configuration Validation Logic** (AC: 1,2,3,6)
  - [ ] URL validation for ThetaData base URL (default: http://localhost:25510)
  - [ ] Date validation for processing start date with business day checks
  - [ ] Directory path validation with automatic creation capabilities
  - [ ] Cross-field validation rules for configuration consistency

- [ ] **Task 5: Unit Testing** (AC: All)
  - [ ] Test configuration schema validation with valid/invalid inputs
  - [ ] Test SQLite CRUD operations with Effect testing utilities
  - [ ] Test CLI commands with mock database and file system
  - [ ] Test validation logic with property-based testing for edge cases

## Dev Notes

### Previous Story Insights
No previous story exists - this is the foundational configuration story.

### Configuration Schema Details
[Source: architecture/configuration-management.md#effect-config-integration]
- **AppConfig Structure**: Use Effect Config.all() pattern with nested configuration sections
- **ThetaData Config**: baseUrl (default: "http://localhost:25510"), maxConcurrentRequests (default: 4)
- **Processing Config**: startDate (required), outputDirectory (default: "./data/parquet"), tempDirectory (default: "./data/temp")
- **Database Config**: path (default: "./data/spx-pipeline.db")

### Database Schema Requirements
[Source: architecture/database-schema.md#sqlite-status-tracking]
```sql
CREATE TABLE configuration (
  key TEXT PRIMARY KEY,
  value TEXT NOT NULL,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### CLI Command Architecture
[Source: architecture/cli-interface-architecture.md#configuration-commands]
- Main CLI app uses Command.make("spx-data") with subcommands array
- Configuration commands: config set, config get, config validate, config reset
- Use @effect/cli with Options for command line parsing
- Commands must provide clear help text and parameter validation

### File Location Guidelines
[Source: architecture/system-architecture.md#module-structure]
- Configuration types: `src/types/domain/`
- CLI commands: `src/cli/commands/`
- Configuration management: `src/cli/config/`
- Database operations: `src/infrastructure/database/`
- Error definitions: `src/types/errors/`

### Effect Services Integration
[Source: architecture/system-architecture.md#effect-services-architecture]
- Implement ConfigService as part of Services interface
- Use Effect dependency injection pattern
- DatabaseService integration for persistence
- Error handling through AppError type hierarchy

### Technical Constraints
[Source: architecture/technology-stack.md#core-effect-ts-ecosystem]
- Use `@effect/cli@0.36.x` for CLI framework
- Use `@effect/schema@0.67.x` for runtime validation
- Use `@effect/sql-sqlite@0.x` for database integration
- Use `bun` as runtime with native TypeScript support

### Testing
**Testing Requirements** [Source: architecture/testing-strategy.md#tdd-with-effect-ts]
- Test file location: Follow TDD pattern with tests adjacent to implementation
- Testing frameworks: Use Effect testing utilities with describe/it pattern
- Unit tests: Effect.gen() with mock services using Effect.provide()
- Integration tests: Test CLI commands with real database in memory
- Property testing: Use fast-check for configuration validation edge cases
- All tests must use Effect.runPromise for async operations

**Testing Standards**:
- Test configuration schema validation with valid and invalid inputs
- Test database operations with Effect mock services
- Test CLI command parsing and execution
- Test error handling and validation messages
- Minimum 90% code coverage for configuration components

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-03 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- Configuration schema implementation completed with Effect Schema validation
- SQLite repository layer implemented with @effect/sql-sqlite-bun integration fully working
- CLI framework setup with @effect/cli commands fully operational
- Database initialization system implemented with comprehensive safety checks
- All configuration commands tested and verified working: set, get, validate, reset
- Database management commands added: status, init, force-init with data preservation

### Completion Notes List
- ✅ **Task 1 Complete**: Configuration schema with comprehensive validation, error handling, and TypeScript types
- ✅ **Task 2 Complete**: SQLite configuration storage with Effect SQL integration fully working
- ✅ **Task 3 Complete**: CLI configuration commands implemented and tested - all commands working
- ✅ **Task 3a Complete**: Database initialization system with safety verification and data preservation
- ⏳ **Tasks 4-5 Pending**: Validation logic and unit testing 

### File List
**Created Files:**
- `package.json` - Project configuration with Effect-TS dependencies
- `tsconfig.json` - TypeScript configuration for Effect-TS patterns
- `vitest.config.ts` - Testing configuration
- `src/types/domain/Configuration.ts` - Configuration schema with Effect Schema validation
- `src/types/errors/ConfigurationError.ts` - Typed error hierarchy for configuration operations
- `src/infrastructure/database/ConfigurationRepository.ts` - SQLite repository with Effect SQL integration
- `src/cli/config/ConfigurationService.ts` - Configuration service layer
- `src/cli/commands/config.ts` - CLI configuration commands (fully working)
- `src/cli/commands/database.ts` - Database management CLI commands
- `src/infrastructure/database/DatabaseInitialization.ts` - Centralized database initialization with safety checks
- `src/cli.ts` - Main CLI application entry point (fully working)
- `tests/types/domain/Configuration.test.ts` - Configuration schema tests (13 tests passing)
- `tests/infrastructure/database/ConfigurationRepository.test.ts` - Repository tests (pending API fixes)

**Directory Structure:**
- `src/types/{domain,api,errors}/` - Type definitions
- `src/cli/{commands,config,output}/` - CLI interface components  
- `src/infrastructure/{database,thetadata,filesystem}/` - External integrations
- `tests/` - Test files matching source structure
- `data/{parquet,temp}/` - Data directories

## QA Results
*This section will be populated by the QA agent after implementation review*